{"version":3,"file":"content-editable-extension-cjs.js","sources":["../src/isInEditableElement.ts","../src/isNeedAssociate.ts","../src/main.ts"],"sourcesContent":["/*\r\n* Is in content-editable dom\r\n* This needs to be bound\r\n*/\r\nexport default function isInEditableElement(this: any, range: Range): number {\r\n  let { commonAncestorContainer } = range;\r\n  let isIn = 1, isBreak = 0;\r\n\r\n  if ( commonAncestorContainer === this.dom ) { return isIn; }\r\n\r\n  while ( (commonAncestorContainer = commonAncestorContainer.parentElement as Node) && !isBreak ) {\r\n    const { nodeName } = commonAncestorContainer;\r\n    if ( nodeName === 'BODY' ) {\r\n      [isIn, isBreak] = [0, 1];\r\n    }\r\n    else if ( commonAncestorContainer === this.dom ) {\r\n      isBreak = 1;\r\n    }\r\n  }\r\n  \r\n  return isIn;\r\n}\r\n","import { AssoicateObj } from './type/index';\r\n/*\r\n* Determine if you need to associate, exmple: @ewwe\r\n*/\r\nfunction isNeedAssoicate(inputStr: string): AssoicateObj {\r\n  const obj = {\r\n    isNeed: 0,\r\n    inputStr: '',\r\n  };\r\n  \r\n  const reg = /@(\\w|[\\u4e00-\\u9fa5])+$/;\r\n\r\n  if ( reg.test(inputStr) ) {\r\n    obj.isNeed = 1;\r\n    const matchStr = reg.exec(inputStr) || []\r\n    obj.inputStr =matchStr[0] || '';\r\n  }\r\n\r\n  return obj;\r\n}\r\n\r\nexport default isNeedAssoicate;\r\n","import isInEditableElement from './isInEditableElement';\r\nimport isNeedAssoicate from './isNeedAssociate';\r\n\r\ntype selectionType = {\r\n  ['type']: string,\r\n  createRange: Function,\r\n}\r\n\r\ndeclare global {\r\n  interface Document {\r\n      selection: typeof Selection & selectionType;\r\n  }\r\n}\r\n\r\n/*\r\n* @params dom: Set content-editable dom\r\n* @params isNeedAssociate: Determine if you need to associate\r\n* @params associateHandleCb: associate callback\r\n*/\r\nexport default class CEExtension {\r\n  constructor(dom: HTMLElement, isNeedAssociate: number | boolean = 0, associateHandleCb = () => {}) {\r\n    if (!dom) { throw Error('Params dom is not null'); }\r\n\r\n    this.dom = dom;\r\n    this.associateHandleCb = associateHandleCb;\r\n    this.setContentEditable();\r\n    isNeedAssociate && this.addChangeEvent();\r\n  }\r\n\r\n  private dom: HTMLElement;\r\n  private associateHandleCb: Function;\r\n\r\n  private setContentEditable( ) {\r\n    const { dom } = this;\r\n    const contenteditableValue = dom.getAttribute('contenteditable');\r\n\r\n    if (!contenteditableValue || contenteditableValue === 'false' ) {\r\n      dom.setAttribute('contenteditable', 'true');\r\n    }\r\n  }\r\n\r\n  private addChangeEvent() {\r\n    const { dom } = this;\r\n    dom.addEventListener('input', e => {\r\n      const { target } = e;\r\n      const innerHTML = (< HTMLElement>target).innerHTML;\r\n      const selection = window.getSelection();\r\n      const range = selection?.getRangeAt(0);\r\n      const textNode = range!.commonAncestorContainer;\r\n      const isNeedObj = isNeedAssoicate(textNode.textContent || '');\r\n      console.log(isNeedObj);\r\n      // Calculate whether input association processing is required\r\n      this.associateHandleCb(isNeedObj);\r\n    })\r\n  }\r\n\r\n  /*\r\n  * Params htmlStr: <img src=\"./img/oip-c.jpg\" alt=\"图片\" />\r\n  * Params isAssociate: @ associate\r\n  */\r\n  insert( htmlStr: string, isAssociate: boolean | number ) {\r\n    if ( isAssociate ) { CEExtension.setCursorToLast(this.dom); }\r\n    if ( window.getSelection ) {\r\n      const selection = window.getSelection();\r\n      let range = selection!.getRangeAt(0);\r\n\r\n      // If the selection is not inside the content-editable dom element, it is not processed\r\n      if ( !isInEditableElement.call(this, range) ) { return; }\r\n\r\n      if ( selection?.getRangeAt && selection.rangeCount ) {\r\n        const el = document.createElement('div');\r\n        let rangeLastNode: Node | null = null;\r\n        el.innerHTML = htmlStr;\r\n\r\n        const frag = document.createDocumentFragment();\r\n        let node: ChildNode | null, lastNode!: ChildNode;\r\n\r\n        while ( node = el.firstChild ) {\r\n          lastNode = frag.appendChild(node);\r\n        }\r\n\r\n        // Deletes the '@esdss' characters entered\r\n        if ( isAssociate ) {\r\n          const { childNodes } = range.commonAncestorContainer;\r\n          const childNodeLen = childNodes.length;\r\n          rangeLastNode = childNodes[childNodeLen -1];\r\n\r\n          for (let i = childNodeLen -1; i >= 0; i--) {\r\n            const element = childNodes[i];\r\n            const { textContent } = element;\r\n\r\n            if ( textContent && textContent.includes('@') ) {\r\n              const position = textContent.lastIndexOf('@');\r\n              element.textContent = textContent.substring(0, position + 1);\r\n              break;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Append is used if the element is DIV, insertNode is used otherwise\r\n        if ( rangeLastNode && rangeLastNode.nodeName === 'DIV' ) {\r\n          rangeLastNode.appendChild(frag)\r\n        }\r\n        else {\r\n          range?.insertNode( frag );\r\n        }\r\n\r\n        if ( lastNode ) {\r\n          range = range?.cloneRange();\r\n          range?.setStartAfter(lastNode);\r\n          range?.collapse(true);\r\n          selection.removeAllRanges();\r\n          selection.addRange(range);\r\n        }\r\n      }\r\n      else if ( document.selection.type !== 'Control' ) {\r\n        document.selection.createRange().pastHTML(htmlStr);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Sets the rear side of the cursor positioning content.\r\n  static setCursorToLast( dom: HTMLElement ) {\r\n    if (!dom) { throw Error('Params dom is not null'); }\r\n\r\n    if ( window.getSelection ) {\r\n      dom.focus();\r\n\r\n      const selection = window.getSelection();\r\n      selection?.selectAllChildren( dom );\r\n      selection?.collapseToEnd();\r\n    }\r\n    else if ( document.selection ) {  // IE10 9 8 7 6 5\r\n      const range = document.selection.createRange();\r\n      range.moveToElementText( dom );\r\n      range.collapse( false );\r\n      range.select();\r\n    }\r\n  }\r\n\r\n  // Sets the position of the association list\r\n  static setPositionOfAssociateList(associateList: HTMLElement) {\r\n    if (!associateList) { throw Error('Params associateList is not null'); }\r\n\r\n    if ( window.getSelection ) {\r\n      const selection = window.getSelection();\r\n      const range = selection!.getRangeAt(0);\r\n      const textNode = range.commonAncestorContainer;\r\n      console.log(range);\r\n      const tempRange = document.createRange();\r\n      tempRange.selectNodeContents(textNode);\r\n      const rects = Object.prototype.hasOwnProperty.call(tempRange, 'getBoundingClientRect')\r\n        ? tempRange.getBoundingClientRect() : tempRange.getClientRects()[0];\r\n      console.log(textNode.textContent);\r\n\r\n      // 'sdwes@ew'字符串中@之前的字符长度\r\n      const beforeStrLen = textNode.textContent?.lastIndexOf('@') || 0;\r\n      const CORRECT_WIDTH_VALUE = 8, CORRECT_HEIGHT_VALUE = 16;\r\n\r\n      associateList.style.position = 'absolute';\r\n      associateList.style.left = rects.left + CORRECT_WIDTH_VALUE * beforeStrLen + 'px';\r\n      associateList.style.top = rects.top + CORRECT_HEIGHT_VALUE + 'px';\r\n    }\r\n  }\r\n  \r\n  getValue() {\r\n    return this.dom.innerHTML;\r\n  }\r\n}"],"names":[],"mappings":"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"}