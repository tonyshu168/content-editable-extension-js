{"version":3,"file":"content-editable-extension-umd.js","sources":["../src/isInEditableElement.ts","../src/isNeedAssociate.ts","../src/main.ts"],"sourcesContent":["/*\r\n* Is in content-editable dom\r\n* This needs to be bound\r\n*/\r\nexport default function isInEditableElement(this: any, range: Range): number {\r\n  let { commonAncestorContainer } = range;\r\n  let isIn = 1, isBreak = 0;\r\n\r\n  if ( commonAncestorContainer === this.dom ) { return isIn; }\r\n\r\n  while ( (commonAncestorContainer = commonAncestorContainer.parentElement as Node) && !isBreak ) {\r\n    const { nodeName } = commonAncestorContainer;\r\n    if ( nodeName === 'BODY' ) {\r\n      [isIn, isBreak] = [0, 1];\r\n    }\r\n    else if ( commonAncestorContainer === this.dom ) {\r\n      isBreak = 1;\r\n    }\r\n  }\r\n  \r\n  return isIn;\r\n}\r\n","import { AssoicateObj } from './type/index';\r\n/*\r\n* Determine if you need to associate, exmple: @ewwe\r\n*/\r\nfunction isNeedAssoicate(inputStr: string): AssoicateObj {\r\n  const obj = {\r\n    isNeed: 0,\r\n    inputStr: '',\r\n  };\r\n  \r\n  const reg = /@(\\w|[\\u4e00-\\u9fa5])+$/;\r\n\r\n  if ( reg.test(inputStr) ) {\r\n    obj.isNeed = 1;\r\n    const matchStr = reg.exec(inputStr) || []\r\n    obj.inputStr =matchStr[0] || '';\r\n  }\r\n\r\n  return obj;\r\n}\r\n\r\nexport default isNeedAssoicate;\r\n","import isInEditableElement from './isInEditableElement';\r\nimport isNeedAssoicate from './isNeedAssociate';\r\n\r\ntype selectionType = {\r\n  ['type']: string,\r\n  createRange: Function,\r\n}\r\n\r\ndeclare global {\r\n  interface Document {\r\n      selection: typeof Selection & selectionType;\r\n  }\r\n}\r\n\r\n/*\r\n* @params dom: Set content-editable dom\r\n* @params isNeedAssociate: Determine if you need to associate\r\n* @params associateHandleCb: associate callback\r\n*/\r\nexport default class CEExtension {\r\n  constructor(dom: HTMLElement, isNeedAssociate: number | boolean = 0, associateHandleCb = () => {}) {\r\n    if (!dom) { throw Error('Params dom is not null'); }\r\n\r\n    this.dom = dom;\r\n    this.associateHandleCb = associateHandleCb;\r\n    this.setContentEditable();\r\n    isNeedAssociate && this.addChangeEvent();\r\n  }\r\n\r\n  private dom: HTMLElement;\r\n  private associateHandleCb: Function;\r\n\r\n  private setContentEditable( ) {\r\n    const { dom } = this;\r\n    const contenteditableValue = dom.getAttribute('contenteditable');\r\n\r\n    if (!contenteditableValue || contenteditableValue === 'false' ) {\r\n      dom.setAttribute('contenteditable', 'true');\r\n    }\r\n  }\r\n\r\n  private addChangeEvent() {\r\n    const { dom } = this;\r\n    dom.addEventListener('input', e => {\r\n      const { target } = e;\r\n      const innerHTML = (< HTMLElement>target).innerHTML;\r\n      const isNeedObj = isNeedAssoicate(innerHTML);\r\n      console.log(isNeedObj);\r\n      // 计算\r\n      this.associateHandleCb(isNeedObj);\r\n    })\r\n  }\r\n\r\n  /*\r\n  * Params htmlStr: <img src=\"./img/oip-c.jpg\" alt=\"图片\" />\r\n  * Params isAssociate: @ associate\r\n  */\r\n  insert( htmlStr: string, isAssociate: boolean | number ) {\r\n    if ( isAssociate ) { CEExtension.setCursorToLast(this.dom); }\r\n    if ( window.getSelection ) {\r\n      const selection = window.getSelection();\r\n      let range = selection!.getRangeAt(0);\r\n\r\n      // If the selection is not inside the content-editable dom element, it is not processed\r\n      if ( !isInEditableElement.call(this, range) ) { return; }\r\n\r\n      if ( selection?.getRangeAt && selection.rangeCount ) {\r\n        const el = document.createElement('div');\r\n        el.innerHTML = htmlStr;\r\n\r\n        const frag = document.createDocumentFragment();\r\n        let node: ChildNode | null, lastNode!: ChildNode;\r\n\r\n        while ( node = el.firstChild ) {\r\n          lastNode = frag.appendChild(node);\r\n        }\r\n\r\n        // Deletes the '@esdss' characters entered\r\n        if ( isAssociate ) {\r\n          const { childNodes } = range.commonAncestorContainer;\r\n\r\n          for (let i = childNodes.length -1; i >= 0; i--) {\r\n            const element = childNodes[i];\r\n            const { textContent } = element;\r\n\r\n            if ( textContent && textContent.includes('@') ) {\r\n              const position = textContent.lastIndexOf('@');\r\n              element.textContent = textContent.substring(0, position + 1);\r\n              break;\r\n            }\r\n          }\r\n        }\r\n\r\n        range?.insertNode( frag );\r\n\r\n        if ( lastNode ) {\r\n          range = range?.cloneRange();\r\n          range?.setStartAfter(lastNode);\r\n          range?.collapse(true);\r\n          selection.removeAllRanges();\r\n          selection.addRange(range);\r\n        }\r\n      }\r\n      else if ( document.selection.type !== 'Control' ) {\r\n        document.selection.createRange().pastHTML(htmlStr);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Sets the rear side of the cursor positioning content.\r\n  static setCursorToLast( dom: HTMLElement ) {\r\n    if (!dom) { throw Error('Params dom is not null'); }\r\n\r\n    if ( window.getSelection ) {\r\n      dom.focus();\r\n\r\n      const selection = window.getSelection();\r\n      selection?.selectAllChildren( dom );\r\n      selection?.collapseToEnd();\r\n    }\r\n    else if ( document.selection ) {  // IE10 9 8 7 6 5\r\n      const range = document.selection.createRange();\r\n      range.moveToElementText( dom );\r\n      range.collapse( false );\r\n      range.select();\r\n    }\r\n  }\r\n  \r\n  getValue() {\r\n    return this.dom.innerHTML;\r\n  }\r\n}"],"names":[],"mappings":"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"}